<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Class Fund Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        /* Light theme colors */
        --color-bg: #f8fafc;
        --color-surface: #ffffff;
        --color-surface-elevated: #ffffff;
        --color-text: #1e293b;
        --color-text-secondary: #64748b;
        --color-primary: #3b82f6;
        --color-primary-hover: #2563eb;
        --color-primary-light: #dbeafe;
        --color-success: #10b981;
        --color-warning: #f59e0b;
        --color-error: #ef4444;
        --color-info: #3b82f6;
        --color-border: #e2e8f0;
        --color-status-paid: #10b981;
        --color-status-unpaid: #ef4444;
        --color-status-partial: #f59e0b;
        --color-shadow: rgba(0, 0, 0, 0.05);
        --color-shadow-heavy: rgba(0, 0, 0, 0.1);

        /* Spacing */
        --space-xs: 0.25rem;
        --space-sm: 0.5rem;
        --space-md: 1rem;
        --space-lg: 1.5rem;
        --space-xl: 2rem;

        /* Border radius */
        --radius-sm: 4px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --radius-xl: 16px;
        --radius-full: 9999px;

        /* Typography */
        --text-xs: 0.75rem;
        --text-sm: 0.875rem;
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;
        --text-3xl: 1.875rem;

        /* Transitions */
        --transition-fast: 0.15s;
        --transition-normal: 0.3s;
        --transition-slow: 0.5s;
      }

      /* Dark theme colors */
      [data-theme="dark"] {
        --color-bg: #0f172a;
        --color-surface: #1e293b;
        --color-surface-elevated: #334155;
        --color-text: #f8fafc;
        --color-text-secondary: #94a3b8;
        --color-primary: #60a5fa;
        --color-primary-hover: #93c5fd;
        --color-primary-light: #1e3a8a;
        --color-success: #34d399;
        --color-warning: #fbbf24;
        --color-error: #f87171;
        --color-info: #60a5fa;
        --color-border: #334155;
        --color-status-paid: #34d399;
        --color-status-unpaid: #f87171;
        --color-status-partial: #fbbf24;
        --color-shadow: rgba(0, 0, 0, 0.2);
        --color-shadow-heavy: rgba(0, 0, 0, 0.3);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background-color: var(--color-bg);
        color: var(--color-text);
        line-height: 1.5;
        transition: background-color var(--transition-normal),
          color var(--transition-normal);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-family: "Plus Jakarta Sans", -apple-system, BlinkMacSystemFont,
          sans-serif;
        font-weight: 600;
      }

      /* Header styles */
      .app-header {
        position: sticky;
        top: 0;
        z-index: 100;
        background-color: var(--color-surface);
        box-shadow: 0 1px 2px var(--color-shadow);
        padding: var(--space-md) var(--space-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color var(--transition-normal),
          box-shadow var(--transition-normal);
      }

      .app-title {
        font-size: var(--text-xl);
        font-weight: 700;
        color: var(--color-primary);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
      }

      .app-title svg {
        width: 1.5em;
        height: 1.5em;
      }

      .header-actions {
        display: flex;
        gap: var(--space-sm);
        align-items: center;
      }

      .collection-date {
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
        display: flex;
        align-items: center;
        gap: var(--space-xs);
      }

      /* Main content */
      .app-main {
        flex: 1;
        padding: var(--space-lg);
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
      }

      /* Action buttons */
      .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-sm);
        margin-bottom: var(--space-lg);
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-xs);
        padding: 0.625rem 1.25rem;
        border-radius: var(--radius-md);
        font-weight: 500;
        font-size: var(--text-sm);
        cursor: pointer;
        transition: all var(--transition-fast);
        border: none;
        white-space: nowrap;
      }

      .btn-primary {
        background-color: var(--color-primary);
        color: white;
      }

      .btn-primary:hover {
        background-color: var(--color-primary-hover);
        transform: translateY(-1px);
      }

      .btn-primary:active {
        transform: translateY(0);
      }

      .btn-outline {
        background-color: transparent;
        color: var(--color-primary);
        border: 1px solid var(--color-primary);
      }

      .btn-outline:hover {
        background-color: var(--color-primary-light);
        transform: translateY(-1px);
      }

      .btn-outline:active {
        transform: translateY(0);
      }

      .btn-danger {
        background-color: var(--color-error);
        color: white;
      }

      .btn-danger:hover {
        background-color: #dc2626;
        transform: translateY(-1px);
      }

      .btn-danger:active {
        transform: translateY(0);
      }

      .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: var(--text-xs);
      }

      .btn-icon {
        padding: 0.5rem;
        border-radius: var(--radius-full);
      }

      .btn-icon svg {
        width: 1.25em;
        height: 1.25em;
      }

      /* Search input */
      .search-container {
        position: relative;
        margin-bottom: var(--space-lg);
        max-width: 500px;
        width: 100%;
      }

      .search-input {
        width: 100%;
        padding: 0.625rem 1rem 0.625rem 2.5rem;
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
        background-color: var(--color-surface);
        color: var(--color-text);
        font-size: var(--text-sm);
        transition: all var(--transition-fast);
      }

      .search-input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
      }

      .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--color-text-secondary);
      }

      /* Tab navigation */
      .tab-navigation {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: var(--color-surface);
        box-shadow: 0 -1px 3px var(--color-shadow);
        padding: var(--space-sm) var(--space-lg)
          calc(var(--space-sm) + env(safe-area-inset-bottom));
        z-index: 90;
      }

      .tabs-container {
        overflow-x: auto;
        scrollbar-width: none; /* Hide scrollbar for Firefox */
      }

      .tabs-container::-webkit-scrollbar {
        display: none; /* Hide scrollbar for Chrome/Safari */
      }

      .tabs {
        display: flex;
        gap: var(--space-sm);
        padding-bottom: var(--space-xs);
      }

      .tab {
        position: relative;
        padding: 0.5rem 1rem;
        background-color: var(--color-surface);
        border-radius: var(--radius-md);
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
        transition: all var(--transition-fast);
        flex-shrink: 0;
        border: none;
        font-weight: 500;
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
        border: 1px solid var(--color-border);
      }

      .tab.active {
        background-color: var(--color-primary);
        color: white;
        border-color: var(--color-primary);
      }

      .tab-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        background-color: var(--color-error);
        color: white;
        border-radius: var(--radius-full);
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-xs);
        font-weight: 600;
      }

      /* Card styles */
      .card {
        background-color: var(--color-surface);
        border-radius: var(--radius-lg);
        box-shadow: 0 1px 3px var(--color-shadow);
        overflow: hidden;
        margin-bottom: var(--space-lg);
      }

      .card-header {
        padding: var(--space-md) var(--space-lg);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .card-title {
        font-size: var(--text-lg);
        font-weight: 600;
      }

      .card-body {
        padding: var(--space-lg);
      }

      /* Table wrapper - FIXED STYLES */
      .table-wrapper {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        margin: 0 auto;
        position: relative;
        scrollbar-width: none; /* For Firefox */
      }

      .table-wrapper::-webkit-scrollbar {
        display: none; /* For Chrome/Safari */
      }

      /* Add a subtle shadow to indicate scrollable area when scrolling */
      .table-wrapper.scrolling {
        box-shadow: inset -10px 0 10px -10px rgba(0, 0, 0, 0.1);
      }

      [data-theme="dark"] .table-wrapper.scrolling {
        box-shadow: inset -10px 0 10px -10px rgba(0, 0, 0, 0.3);
      }

      /* Table styling */
      .table-wrapper table {
        min-width: 100%; /* Force table to be at least as wide as container */
        width: auto; /* Allow table to expand beyond container */
        white-space: nowrap; /* Prevent text wrapping */
        border-collapse: separate;
        border-spacing: 0;
      }

      /* Table styles */
      th {
        text-align: left;
        padding: var(--space-sm) var(--space-md);
        font-weight: 600;
        color: var(--color-text-secondary);
        background-color: var(--color-surface);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      td {
        padding: var(--space-sm) var(--space-md);
        vertical-align: middle;
        border-top: 1px solid var(--color-border);
      }

      tr:hover {
        background-color: var(--color-surface-elevated);
      }

      .status {
        font-weight: 600;
        text-transform: uppercase;
        font-size: var(--text-xs);
        letter-spacing: 0.05em;
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-sm);
        display: inline-block;
      }

      .status-paid {
        background-color: rgba(16, 185, 129, 0.1);
        color: var(--color-status-paid);
      }

      .status-unpaid {
        background-color: rgba(239, 68, 68, 0.1);
        color: var(--color-status-unpaid);
      }

      .status-partial {
        background-color: rgba(245, 158, 11, 0.1);
        color: var(--color-status-partial);
      }

      /* Form inputs */
      .form-control {
        width: 100%;
        padding: 0.625rem 0.75rem;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        background-color: var(--color-surface);
        color: var(--color-text);
        font-size: var(--text-sm);
        transition: all var(--transition-fast);
      }

      .form-control:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
      }

      .form-group {
        margin-bottom: var(--space-md);
      }

      .form-label {
        display: block;
        margin-bottom: var(--space-xs);
        font-weight: 500;
        color: var(--color-text);
      }

      /* Summary cards */
      .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-md);
        margin-top: var(--space-lg);
      }

      .summary-card {
        background-color: var(--color-surface);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        box-shadow: 0 1px 2px var(--color-shadow);
        text-align: center;
      }

      .summary-card-title {
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
        margin-bottom: var(--space-xs);
      }

      .summary-card-value {
        font-size: var(--text-xl);
        font-weight: 700;
        color: var(--color-primary);
      }

      /* Empty state */
      .empty-state {
        text-align: center;
        padding: var(--space-xl) var(--space-lg);
        color: var(--color-text-secondary);
      }

      .empty-state-icon {
        width: 64px;
        height: 64px;
        margin-bottom: var(--space-md);
        opacity: 0.5;
      }

      .empty-state-title {
        font-size: var(--text-lg);
        margin-bottom: var(--space-xs);
      }

      .empty-state-description {
        font-size: var(--text-sm);
      }

      /* Modal styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--transition-normal);
        backdrop-filter: blur(4px);
      }

      .modal-overlay.show {
        opacity: 1;
        pointer-events: auto;
      }

      .modal {
        background-color: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        transform: translateY(20px);
        transition: transform var(--transition-normal);
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-overlay.show .modal {
        transform: translateY(0);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-lg);
      }

      .modal-title {
        font-size: var(--text-xl);
        font-weight: 600;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: var(--text-xl);
        cursor: pointer;
        color: var(--color-text-secondary);
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-full);
        transition: all var(--transition-fast);
      }

      .modal-close:hover {
        background-color: var(--color-surface-elevated);
        color: var(--color-error);
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: var(--space-sm);
        margin-top: var(--space-lg);
      }

      /* Notification */
      .notification {
        position: fixed;
        top: var(--space-lg);
        right: var(--space-lg);
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        color: white;
        font-weight: 500;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1100;
        transform: translateX(150%);
        transition: transform var(--transition-normal);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        background-color: var(--color-success);
      }

      .notification.error {
        background-color: var(--color-error);
      }

      .notification.warning {
        background-color: var(--color-warning);
      }

      .notification.info {
        background-color: var(--color-info);
      }

      /* Badge */
      .badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: 600;
        background-color: var(--color-surface-elevated);
        color: var(--color-text);
      }

      /* Utility classes */
      .text-muted {
        color: var(--color-text-secondary);
      }

      .text-center {
        text-align: center;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .app-main {
          padding: var(--space-md);
        }

        .action-buttons {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }

        .summary-cards {
          grid-template-columns: 1fr;
        }

        /* Improved mobile table styles */
        .table-wrapper {
          margin-left: -1rem;
          margin-right: -1rem;
          width: calc(100% + 2rem);
        }

        .card-body {
          padding: var(--space-md);
        }
      }

      @media (max-width: 480px) {
        .app-header {
          flex-direction: column;
          gap: var(--space-sm);
          align-items: flex-start;
        }

        .header-actions {
          width: 100%;
          justify-content: space-between;
        }

        .modal {
          width: 95%;
          padding: var(--space-md);
        }

        /* Force full width tables on very small screens */
        .table-wrapper {
          margin-left: -1rem;
          margin-right: -1rem;
          width: calc(100% + 2rem);
        }

        .table-wrapper table {
          min-width: 600px; /* Minimum width to ensure all columns show */
        }
      }

      /* Add to your existing styles */
      .app-main {
        padding-bottom: 80px; /* Creates space for the tab navigation */
      }

      .summary-cards {
        margin-bottom: 20px; /* Extra space below totals */
      }

      /* For mobile devices */
      @media (max-width: 768px) {
        .app-main {
          padding-bottom: 100px; /* More space on mobile */
        }

        .table-wrapper {
          margin-bottom: 20px; /* Space between table and totals */
        }
      }

      /* Custom delete confirmation modal */
      .delete-confirmation {
        text-align: center;
        padding: var(--space-md);
      }

      .delete-confirmation h3 {
        margin-bottom: var(--space-md);
      }

      .delete-confirmation-buttons {
        display: flex;
        justify-content: center;
        gap: var(--space-md);
        margin-top: var(--space-lg);
      }

      /* Gender selection styles */
      .gender-selection {
        display: flex;
        gap: var(--space-md);
        margin-bottom: var(--space-md);
      }

      .gender-option {
        flex: 1;
        text-align: center;
      }

      .gender-btn {
        width: 100%;
        padding: var(--space-md);
        border: 2px solid var(--color-border);
        border-radius: var(--radius-md);
        background: none;
        cursor: pointer;
        transition: all var(--transition-fast);
      }

      .gender-btn.selected {
        border-color: var(--color-primary);
        background-color: var(--color-primary-light);
      }

      .gender-btn svg {
        width: 24px;
        height: 24px;
        margin-bottom: var(--space-xs);
      }

      .gender-btn .gender-label {
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <h1 class="app-title">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
        >
          <path d="M12 7.5a2.25 2.25 0 100 4.5 2.25 2.25 0 000-4.5z" />
          <path
            fill-rule="evenodd"
            d="M1.5 4.875C1.5 3.839 2.34 3 3.375 3h17.25c1.035 0 1.875.84 1.875 1.875v9.75c0 1.036-.84 1.875-1.875 1.875H3.375A1.875 1.875 0 011.5 14.625v-9.75zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 01.67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 11-.671-1.34l.041-.022zM12 9a.75.75 0 100-1.5.75.75 0 000 1.5z"
            clip-rule="evenodd"
          />
        </svg>
        Class Fund Manager
      </h1>
      <div class="header-actions">
        <div class="collection-date">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            width="16"
            height="16"
          >
            <path
              fill-rule="evenodd"
              d="M6.75 2.25A.75.75 0 017.5 3v1.5h9V3A.75.75 0 0118 3v1.5h.75a3 3 0 013 3v11.25a3 3 0 01-3 3H5.25a3 3 0 01-3-3V7.5a3 3 0 013-3H6V3a.75.75 0 01.75-.75zm13.5 9a1.5 1.5 0 00-1.5-1.5H5.25a1.5 1.5 0 00-1.5 1.5v7.5a1.5 1.5 0 001.5 1.5h13.5a1.5 1.5 0 001.5-1.5v-7.5z"
              clip-rule="evenodd"
            />
          </svg>
          <span id="date-display">No sheet selected</span>
        </div>
        <button
          id="theme-toggle-btn"
          class="btn btn-icon"
          aria-label="Toggle theme"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            width="20"
            height="20"
          >
            <path
              d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z"
            />
          </svg>
        </button>
      </div>
    </header>

    <main class="app-main">
      <div class="action-buttons">
        <button id="add-sheet-btn" class="btn btn-primary">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            width="16"
            height="16"
          >
            <path
              fill-rule="evenodd"
              d="M5.625 1.5c-1.036 0-1.875.84-1.875 1.875v17.25c0 1.035.84 1.875 1.875 1.875h12.75c1.035 0 1.875-.84 1.875-1.875V12.75A3.75 3.75 0 0016.5 9h-1.875a1.875 1.875 0 01-1.875-1.875V5.25A3.75 3.75 0 009 1.5H5.625zM7.5 15a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5A.75.75 0 017.5 15zm.75 2.25a.75.75 0 000 1.5H12a.75.75 0 000-1.5H8.25z"
              clip-rule="evenodd"
            />
            <path
              d="M12.971 1.816A5.23 5.23 0 0114.25 5.25v1.875c0 .207.168.375.375.375H16.5a5.23 5.23 0 013.434 1.279 9.768 9.768 0 00-6.963-6.963z"
            />
          </svg>
          Add Sheet
        </button>
        <button
          id="add-student-btn"
          class="btn btn-primary"
          style="display: none"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            width="16"
            height="16"
          >
            <path
              d="M6.25 6.375a4.125 4.125 0 118.25 0 4.125 4.125 0 01-8.25 0zM3.25 19.125a7.125 7.125 0 0114.25 0v.003l-.001.119a.75.75 0 01-.363.63 13.067 13.067 0 01-6.761 1.873c-2.472 0-4.786-.684-6.76-1.873a.75.75 0 01-.364-.63l-.001-.122zM19.75 7.5a.75.75 0 00-1.5 0v2.25H16a.75.75 0 000 1.5h2.25v2.25a.75.75 0 001.5 0v-2.25H22a.75.75 0 000-1.5h-2.25V7.5z"
            />
          </svg>
          Add Students
        </button>
        <button id="open-settings-btn" class="btn btn-outline">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            width="16"
            height="16"
          >
            <path
              fill-rule="evenodd"
              d="M11.078 2.25c-.917 0-1.699.663-1.85 1.567L9.05 4.889c-.02.12-.115.26-.297.348a7.493 7.493 0 00-.986.57c-.166.115-.334.126-.45.083L6.3 5.508a1.875 1.875 0 00-2.282.819l-.922 1.597a1.875 1.875 0 00.432 2.385l.84.692c.095.078.17.229.154.43a7.598 7.598 0 000 1.139c.015.2-.059.352-.153.43l-.841.692a1.875 1.875 0 00-.432 2.385l.922 1.597a1.875 1.875 0 002.282.818l1.019-.382c.115-.043.283-.031.45.082.312.214.641.405.985.57.182.088.277.228.297.35l.178 1.071c.151.904.933 1.567 1.85 1.567h1.844c.916 0 1.699-.663 1.85-1.567l.178-1.072c.02-.12.114-.26.297-.349.344-.165.673-.356.985-.57.167-.114.335-.125.45-.082l1.02.382a1.875 1.875 0 002.28-.819l.923-1.597a1.875 1.875 0 00-.432-2.385l-.84-.692c-.095-.078-.17-.229-.154-.43a7.614 7.614 0 000-1.139c-.016-.2.059-.352.153-.43l.84-.692c.708-.582.891-1.59.433-2.385l-.922-1.597a1.875 1.875 0 00-2.282-.818l-1.02.382c-.114.043-.282.031-.449-.083a7.49 7.49 0 00-.985-.57c-.183-.087-.277-.227-.297-.348l-.179-1.072a1.875 1.875 0 00-1.85-1.567h-1.843z"
              clip-rule="evenodd"
            />
            <path d="M12 15.75a3.75 3.75 0 100-7.5 3.75 3.75 0 000 7.5z" />
          </svg>
          Settings
        </button>
      </div>

      <div class="search-container">
        <svg
          class="search-icon"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          width="16"
          height="16"
        >
          <path
            fill-rule="evenodd"
            d="M10.5 3.75a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM2.25 10.5a8.25 8.25 0 1114.59 5.28l4.69 4.69a.75.75 0 11-1.06 1.06l-4.69-4.69A8.25 8.25 0 012.25 10.5z"
            clip-rule="evenodd"
          />
        </svg>
        <input
          type="text"
          id="search-input"
          class="search-input"
          placeholder="Search students..."
          aria-label="Search students"
        />
      </div>

      <!-- Updated table container with proper scrolling -->
      <div id="sheet-content">
        <!-- Content will be rendered here by JavaScript -->
      </div>

      <div id="notification" class="notification"></div>
    </main>

    <!-- Bottom Tab Navigation -->
    <footer class="tab-navigation">
      <div class="tabs-container">
        <div class="tabs" id="sheet-tabs"></div>
      </div>
    </footer>

    <!-- Add Sheet Modal -->
    <div id="add-sheet-modal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title">Add New Sheet</h2>
          <button class="modal-close" id="close-add-sheet-modal">
            &times;
          </button>
        </div>
        <form id="add-sheet-form">
          <div class="form-group">
            <label for="sheet-name" class="form-label">Sheet Name</label>
            <input type="text" id="sheet-name" class="form-control" required />
          </div>
          <div class="form-group">
            <label for="sheet-date" class="form-label">Date</label>
            <input type="date" id="sheet-date" class="form-control" required />
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline" id="cancel-add-sheet">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Create Sheet</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add Student Modal -->
    <div id="add-student-modal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title">Add Students</h2>
          <button class="modal-close" id="close-add-student-modal">
            &times;
          </button>
        </div>
        <form id="add-student-form">
          <div class="form-group">
            <div
              class="card"
              style="
                margin-bottom: var(--space-md);
                background-color: var(--color-primary-light);
              "
            >
              <div
                class="card-body"
                style="padding: var(--space-sm) var(--space-md)"
              >
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: var(--space-sm);
                  "
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                    width="20"
                    height="20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 01.67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 11-.671-1.34l.041-.022zM12 9a.75.75 0 100-1.5.75.75 0 000 1.5z"
                      clip-rule="evenodd"
                    />
                  </svg>
                  <span>Enter student names separated by commas</span>
                </div>
              </div>
            </div>
            <div class="gender-selection">
              <div class="gender-option">
                <button type="button" class="gender-btn" id="male-btn">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 6a.75.75 0 00-1.5 0v6a.75.75 0 001.5 0V6zM12 18a.75.75 0 100-1.5.75.75 0 000 1.5z"
                      clip-rule="evenodd"
                    />
                  </svg>
                  <div class="gender-label">Male</div>
                </button>
              </div>
              <div class="gender-option">
                <button type="button" class="gender-btn" id="female-btn">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 6a.75.75 0 00-1.5 0v6a.75.75 0 001.5 0V6zM12 18a.75.75 0 100-1.5.75.75 0 000 1.5z"
                      clip-rule="evenodd"
                    />
                  </svg>
                  <div class="gender-label">Female</div>
                </button>
              </div>
            </div>
            <label for="student-names" class="form-label">Student Names</label>
            <textarea
              id="student-names"
              class="form-control"
              rows="5"
              placeholder="e.g., Diwata, Mang Boy, Boy Dila, Cardo Dalisay"
              required
            ></textarea>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline"
              id="cancel-add-student"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Add Students</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title">Settings</h2>
          <button class="modal-close" id="close-settings-modal">&times;</button>
        </div>
        <form id="settings-form">
          <div class="form-group">
            <label for="expected-payment" class="form-label"
              >Default Expected Payment</label
            >
            <div style="position: relative">
              <span
                style="
                  position: absolute;
                  left: 0.75rem;
                  top: 50%;
                  transform: translateY(-50%);
                  color: var(--color-text-secondary);
                "
                >â‚±</span
              >
              <input
                type="number"
                id="expected-payment"
                class="form-control"
                style="padding-left: 2rem"
                min="0"
                step="0.01"
                required
              />
            </div>
          </div>
          <div class="form-group">
            <label for="theme-preference" class="form-label"
              >Theme Preference</label
            >
            <select id="theme-preference" class="form-control">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
              <option value="system">System Preference</option>
            </select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline" id="cancel-settings">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Save Settings</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirmation-modal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title">Confirm Deletion</h2>
          <button class="modal-close" id="close-delete-confirmation-modal">
            &times;
          </button>
        </div>
        <div class="delete-confirmation">
          <h3 id="delete-confirmation-message">
            Are you sure you want to delete this item?
          </h3>
          <div class="delete-confirmation-buttons">
            <button type="button" class="btn btn-outline" id="cancel-delete">
              Cancel
            </button>
            <button type="button" class="btn btn-danger" id="confirm-delete">
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      (() => {
        // Utility functions
        const $ = (selector, root = document) => root.querySelector(selector);
        const $$ = (selector, root = document) =>
          Array.from(root.querySelectorAll(selector));
        const formatDate = (date) => date.toISOString().slice(0, 10);
        const todayStr = formatDate(new Date());

        // Sort students alphabetically with males first, then females
        function sortStudentsByGender(students) {
          return students.sort((a, b) => {
            // Sort by gender first (male first)
            if (a.gender !== b.gender) {
              return a.gender === "male" ? -1 : 1;
            }
            // Then sort by name
            const nameA = a.name.toLowerCase();
            const nameB = b.name.toLowerCase();
            return nameA.localeCompare(nameB);
          });
        }

        // State
        let sheets = [];
        let currentSheetId = null;
        let settings = {
          expectedPayment: 100,
          theme: "light",
        };
        let selectedGender = "male"; // Default to male
        let currentDeleteAction = null;

        // DOM elements
        const dateDisplay = $("#date-display");
        const sheetTabs = $("#sheet-tabs");
        const sheetContent = $("#sheet-content");
        const addSheetBtn = $("#add-sheet-btn");
        const addStudentBtn = $("#add-student-btn");
        const openSettingsBtn = $("#open-settings-btn");
        const searchInput = $("#search-input");
        const notification = $("#notification");
        const themeToggleBtn = $("#theme-toggle-btn");
        const maleBtn = $("#male-btn");
        const femaleBtn = $("#female-btn");

        // Modals
        const addSheetModal = $("#add-sheet-modal");
        const addStudentModal = $("#add-student-modal");
        const settingsModal = $("#settings-modal");
        const deleteConfirmationModal = $("#delete-confirmation-modal");

        // Modal close buttons
        const closeAddSheetModalBtn = $("#close-add-sheet-modal");
        const cancelAddSheetBtn = $("#cancel-add-sheet");
        const closeAddStudentModalBtn = $("#close-add-student-modal");
        const cancelAddStudentBtn = $("#cancel-add-student");
        const closeSettingsModalBtn = $("#close-settings-modal");
        const cancelSettingsBtn = $("#cancel-settings");
        const closeDeleteConfirmationModalBtn = $(
          "#close-delete-confirmation-modal"
        );
        const cancelDeleteBtn = $("#cancel-delete");
        const confirmDeleteBtn = $("#confirm-delete");

        // Forms
        const addSheetForm = $("#add-sheet-form");
        const addStudentForm = $("#add-student-form");
        const settingsForm = $("#settings-form");

        // Show notification
        function showNotification(message, type = "success") {
          const icons = {
            success: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" /></svg>`,
            error: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" /></svg>`,
            warning: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" /></svg>`,
            info: `<svg xmlns="http://www3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 01.67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 11-.671-1.34l.041-.022zM12 9a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" /></svg>`,
          };

          notification.innerHTML = `${icons[type] || ""} ${message}`;
          notification.className = `notification ${type} show`;

          setTimeout(() => {
            notification.classList.remove("show");
          }, 3000);
        }

        // Accessibility helper: trap focus inside modal
        function trapFocus(modal) {
          const focusableElements = modal.querySelectorAll(
            "a[href], button:not([disabled]), textarea, input, select"
          );
          const firstFocusable = focusableElements[0];
          const lastFocusable = focusableElements[focusableElements.length - 1];

          modal.addEventListener("keydown", (e) => {
            if (e.key === "Tab") {
              if (e.shiftKey) {
                if (document.activeElement === firstFocusable) {
                  e.preventDefault();
                  lastFocusable.focus();
                }
              } else {
                if (document.activeElement === lastFocusable) {
                  e.preventDefault();
                  firstFocusable.focus();
                }
              }
            }
            if (e.key === "Escape") {
              closeModal(modal);
            }
          });
        }

        // Modal open/close
        function openModal(modal) {
          modal.classList.add("show");
          setTimeout(() => {
            trapFocus(modal);
            // Focus first input or button
            const firstInput = modal.querySelector("input, select, button");
            if (firstInput) firstInput.focus();
          }, 10);
        }

        function closeModal(modal) {
          modal.classList.remove("show");
          // Return focus to last focused button
          if (modal === addSheetModal) addSheetBtn.focus();
          else if (modal === addStudentModal) addStudentBtn.focus();
          else if (modal === settingsModal) openSettingsBtn.focus();
          else if (modal === deleteConfirmationModal) {
            // Return focus to the element that triggered the delete action
            if (currentDeleteAction && currentDeleteAction.trigger) {
              currentDeleteAction.trigger.focus();
            }
          }
        }

        // Save/load from localStorage
        function saveData() {
          localStorage.setItem("cfm_sheets", JSON.stringify(sheets));
          localStorage.setItem("cfm_settings", JSON.stringify(settings));
          localStorage.setItem("cfm_currentSheetId", currentSheetId);
        }

        function loadData() {
          const lsSheets = localStorage.getItem("cfm_sheets");
          const lsSettings = localStorage.getItem("cfm_settings");
          const lsCurrentSheetId = localStorage.getItem("cfm_currentSheetId");

          if (lsSheets) sheets = JSON.parse(lsSheets);
          if (lsSettings) settings = JSON.parse(lsSettings);
          if (lsCurrentSheetId) currentSheetId = lsCurrentSheetId;

          if (!sheets.length) {
            // Create default sheet
            const defaultSheet = createSheet("Student List", todayStr);
            sheets.push(defaultSheet);
            currentSheetId = defaultSheet.id;
          }

          if (!currentSheetId && sheets.length) currentSheetId = sheets[0].id;

          // Ensure first sheet is always Student List
          if (sheets[0].name !== "Student List") {
            sheets[0].name = "Student List";
            saveData();
          }
        }

        // Generate unique ID
        function genId() {
          return "id-" + Math.random().toString(36).slice(2, 10);
        }

        // Create sheet object
        function createSheet(name, date) {
          return {
            id: genId(),
            name,
            date,
            students: [],
          };
        }

        // Create student object
        function createStudent(
          name,
          amountPaid,
          expectedPayment,
          notes = "",
          gender = "male"
        ) {
          const paid = parseFloat(amountPaid) || 0;
          const expected = parseFloat(expectedPayment);
          const remaining = Math.max(expected - paid, 0);
          let status = "Unpaid";
          if (paid === 0) status = "Unpaid";
          else if (paid >= expected) status = "Paid";
          else status = "Partial";
          return {
            id: genId(),
            name,
            amountPaid: paid,
            expectedPayment: expected,
            remainingBalance: remaining,
            status,
            notes,
            gender,
          };
        }

        // Show delete confirmation dialog
        function showDeleteConfirmation(message, action) {
          currentDeleteAction = action;
          $("#delete-confirmation-message").textContent = message;
          openModal(deleteConfirmationModal);
        }

        // Render tabs
        function renderTabs() {
          sheetTabs.innerHTML = "";

          // Add Student List tab
          const studentListTab = document.createElement("button");
          studentListTab.className = "tab";
          studentListTab.setAttribute("role", "tab");
          studentListTab.setAttribute(
            "aria-selected",
            sheets[0]?.id === currentSheetId ? "true" : "false"
          );
          studentListTab.id = `tab-${sheets[0]?.id || "student-list"}`;
          studentListTab.textContent = "Student List";
          if (sheets[0]?.id === currentSheetId)
            studentListTab.classList.add("active");
          studentListTab.addEventListener("click", () => {
            if (sheets[0]?.id !== currentSheetId) {
              currentSheetId = sheets[0]?.id;
              renderTabs();
              renderSheet();
              addStudentBtn.style.display = "flex";
              searchInput.value = "";
            }
          });
          sheetTabs.appendChild(studentListTab);

          // Add other sheets
          sheets.slice(1).forEach((sheet) => {
            const tab = document.createElement("button");
            tab.className = "tab";
            tab.setAttribute("role", "tab");
            tab.setAttribute(
              "aria-selected",
              sheet.id === currentSheetId ? "true" : "false"
            );
            tab.id = `tab-${sheet.id}`;
            tab.textContent = sheet.name;
            if (sheet.id === currentSheetId) tab.classList.add("active");
            tab.addEventListener("click", () => {
              if (sheet.id !== currentSheetId) {
                currentSheetId = sheet.id;
                renderTabs();
                renderSheet();
                addStudentBtn.style.display = "none";
                searchInput.value = "";
              }
            });

            // Add badge for non-default sheets
            const badge = document.createElement("span");
            badge.className = "tab-badge";
            badge.innerHTML = "&times;";
            badge.title = "Remove sheet";
            badge.setAttribute("aria-label", `Remove sheet ${sheet.name}`);
            badge.addEventListener("click", (e) => {
              e.stopPropagation();
              showDeleteConfirmation(`Remove sheet "${sheet.name}"?`, {
                type: "sheet",
                id: sheet.id,
                name: sheet.name,
                trigger: badge,
              });
            });
            tab.appendChild(badge);

            sheetTabs.appendChild(tab);
          });
        }

        // Render sheet content (table + summary)
        function renderSheet() {
          if (currentSheetId === "payment-summary") {
            renderPaymentSummary();
            return;
          }

          const sheet = sheets.find((s) => s.id === currentSheetId);
          if (!sheet) {
            sheetContent.innerHTML = `
        <div class="empty-state">
          <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 01.67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 11-.671-1.34l.041-.022zM12 9a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" />
          </svg>
          <h3 class="empty-state-title">No sheet selected</h3>
          <p class="empty-state-description">Please add a sheet first</p>
        </div>
        `;
            addStudentBtn.disabled = true;
            dateDisplay.textContent = "No sheet selected";
            return;
          }

          // Ensure students are sorted by gender (male first) and then alphabetically
          sheet.students = sortStudentsByGender(sheet.students);

          dateDisplay.textContent = new Date(sheet.date).toLocaleDateString();

          // Filter students by search
          const filterText = searchInput.value.trim().toLowerCase();
          const filteredStudents = sheet.students.filter((st) =>
            st.name.toLowerCase().includes(filterText)
          );

          // Create card container
          const card = document.createElement("div");
          card.className = "card";

          // Card header
          const cardHeader = document.createElement("div");
          cardHeader.className = "card-header";

          const cardTitle = document.createElement("h3");
          cardTitle.className = "card-title";
          cardTitle.textContent = sheet.name;

          const studentCount = document.createElement("span");
          studentCount.className = "badge";
          studentCount.textContent = `${filteredStudents.length} student${
            filteredStudents.length !== 1 ? "s" : ""
          }`;

          cardHeader.appendChild(cardTitle);
          cardHeader.appendChild(studentCount);
          card.appendChild(cardHeader);

          // Card body
          const cardBody = document.createElement("div");
          cardBody.className = "card-body";

          if (filteredStudents.length === 0) {
            // Empty state
            const emptyState = document.createElement("div");
            emptyState.className = "empty-state";

            if (sheet.students.length === 0) {
              emptyState.innerHTML = `
            <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4.5 6.375a4.125 4.125 0 118.25 0 4.125 4.125 0 01-8.25 0zM14.25 8.625a3.375 3.375 0 116.75 0 3.375 3.375 0 01-6.75 0zM1.5 19.125a7.125 7.125 0 0114.25 0v.003l-.001.119a.75.75 0 01-.363.63 13.067 13.067 0 01-6.761 1.873c-2.472 0-4.786-.684-6.76-1.873a.75.75 0 01-.364-.63l-.001-.122zM17.25 19.128l-.001.144a2.25 2.25 0 01-.233.96 10.088 10.088 0 005.06-1.01.75.75 0 00.42-.643 4.875 4.875 0 00-6.957-4.611 8.586 8.586 0 011.71 5.157v.003z" />
            </svg>
            <h3 class="empty-state-title">No students found</h3>
            <p class="empty-state-description">Add some students to this sheet</p>
          `;
            } else {
              emptyState.innerHTML = `
            <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM2.25 10.5a8.25 8.25 0 1114.59 5.28l4.69 4.69a.75.75 0 11-1.06 1.06l-4.69-4.69A8.25 8.25 0 012.25 10.5zm8.25-3.75a.75.75 0 01.75.75v2.25h2.25a.75.75 0 010 1.5h-2.25v2.25a.75.75 0 01-1.5 0v-2.25H7.5a.75.75 0 010-1.5h2.25V7.5a.75.75 0 01.75-.75z" clip-rule="evenodd" />
            </svg>
            <h3 class="empty-state-title">No matches</h3>
            <p class="empty-state-description">No students match your search</p>
          `;
            }

            cardBody.appendChild(emptyState);
          } else {
            // Create table wrapper
            const tableWrapper = document.createElement("div");
            tableWrapper.className = "table-wrapper";

            // Create table
            const table = document.createElement("table");
            table.setAttribute("aria-label", `Students in sheet ${sheet.name}`);

            const thead = document.createElement("thead");
            const headerRow = document.createElement("tr");

            if (sheet.id === sheets[0].id) {
              // Simplified table for default sheet
              headerRow.innerHTML = `
            <th>Student Name</th>
            <th>Gender</th>
            <th style="width: 50px;"></th>
          `;
            } else {
              // Full table for other sheets
              headerRow.innerHTML = `
            <th>Student Name</th>
            <th>Gender</th>
            <th>Status</th>
            <th>Expected</th>
            <th>Paid</th>
            <th>Remaining</th>
            <th>Notes</th>
            <th style="width: 50px;"></th>
          `;
            }

            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement("tbody");

            filteredStudents.forEach((student) => {
              const row = document.createElement("tr");

              // Name
              const nameCell = document.createElement("td");
              nameCell.textContent = student.name;
              row.appendChild(nameCell);

              // Gender
              const genderCell = document.createElement("td");
              genderCell.textContent =
                student.gender === "male" ? "Male" : "Female";
              row.appendChild(genderCell);

              if (sheet.id !== sheets[0].id) {
                // Status
                const statusCell = document.createElement("td");
                const statusBadge = document.createElement("span");
                statusBadge.className = `status status-${student.status.toLowerCase()}`;
                statusBadge.textContent = student.status;
                statusCell.appendChild(statusBadge);
                row.appendChild(statusCell);

                // Expected Payment
                const expectedCell = document.createElement("td");
                expectedCell.textContent = `â‚±${student.expectedPayment.toFixed(
                  2
                )}`;
                row.appendChild(expectedCell);

                // Amount Paid (editable)
                const paidCell = document.createElement("td");
                const paidInput = document.createElement("input");
                paidInput.type = "number";
                paidInput.min = 0;
                paidInput.step = "any";
                paidInput.value =
                  student.amountPaid % 1 === 0
                    ? student.amountPaid.toFixed(0)
                    : student.amountPaid.toFixed(2);
                paidInput.className = "form-control";
                paidInput.style.width = "100px";
                paidInput.setAttribute(
                  "aria-label",
                  `Amount paid by ${student.name}`
                );
                paidInput.addEventListener("change", () => {
                  let val = parseFloat(paidInput.value);
                  if (isNaN(val) || val < 0) val = 0;

                  // Handle excess payment distribution
                  if (val > student.expectedPayment) {
                    const excess = val - student.expectedPayment;
                    val = student.expectedPayment;

                    // Find next unpaid sheets and distribute excess
                    distributeExcessPayment(student.id, excess);
                  }

                  student.amountPaid = val;
                  student.remainingBalance = Math.max(
                    student.expectedPayment - val,
                    0
                  );
                  if (val === 0) student.status = "Unpaid";
                  else if (val >= student.expectedPayment)
                    student.status = "Paid";
                  else student.status = "Partial";
                  saveData();
                  renderSheet();
                  showNotification(
                    `Updated payment for ${student.name}`,
                    "success"
                  );
                });
                paidCell.appendChild(paidInput);
                row.appendChild(paidCell);

                // Remaining Balance
                const remainingCell = document.createElement("td");
                remainingCell.textContent = `â‚±${student.remainingBalance.toFixed(
                  2
                )}`;
                row.appendChild(remainingCell);

                // Notes / Remarks (editable)
                const notesCell = document.createElement("td");
                const notesInput = document.createElement("input");
                notesInput.type = "text";
                notesInput.value = student.notes || "";
                notesInput.placeholder = "Optional";
                notesInput.className = "form-control";
                notesInput.setAttribute(
                  "aria-label",
                  `Notes for ${student.name}`
                );
                notesInput.addEventListener("change", () => {
                  student.notes = notesInput.value.trim();
                  saveData();
                });
                notesCell.appendChild(notesInput);
                row.appendChild(notesCell);
              }

              // Actions: remove student button
              const actionsCell = document.createElement("td");
              const removeBtn = document.createElement("button");
              removeBtn.className = "btn btn-danger btn-sm";
              removeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 013.878.512.75.75 0 11-.256 1.478l-.209-.035-1.005 13.07a3 3 0 01-2.991 2.77H8.084a3 3 0 01-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 01-.256-1.478A48.567 48.567 0 017.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 013.369 0c1.603.051 2.815 1.387 2.815 2.951zm-6.136-1.452a51.196 51.196 0 013.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 00-6 0v-.113c0-.794.609-1.428 1.364-1.452zm-.355 5.945a.75.75 0 10-1.5.058l.347 9a.75.75 0 101.499-.058l-.346-9zm5.48.058a.75.75 0 10-1.498-.058l-.347 9a.75.75 0 001.5.058l.345-9z" clip-rule="evenodd" /></svg>`;
              removeBtn.title = `Remove ${student.name}`;
              removeBtn.setAttribute(
                "aria-label",
                `Remove ${student.name} from sheet`
              );
              removeBtn.addEventListener("click", () => {
                showDeleteConfirmation(
                  `Remove student "${student.name}" from this sheet?`,
                  {
                    type: "student",
                    sheetId: sheet.id,
                    studentId: student.id,
                    name: student.name,
                    trigger: removeBtn,
                  }
                );
              });
              actionsCell.appendChild(removeBtn);
              row.appendChild(actionsCell);

              tbody.appendChild(row);
            });

            table.appendChild(tbody);
            tableWrapper.appendChild(table);
            cardBody.appendChild(tableWrapper);

            // Summary stats (only for non-default sheets)
            if (sheet.id !== sheets[0].id) {
              const summaryCards = document.createElement("div");
              summaryCards.className = "summary-cards";

              const totalExpected = sheet.students.reduce(
                (a, s) => a + s.expectedPayment,
                0
              );
              const totalPaid = sheet.students.reduce(
                (a, s) => a + s.amountPaid,
                0
              );
              const totalRemaining = sheet.students.reduce(
                (a, s) => a + s.remainingBalance,
                0
              );

              const expectedCard = document.createElement("div");
              expectedCard.className = "summary-card";
              expectedCard.innerHTML = `<div class="summary-card-title">Total Expected</div><div class="summary-card-value">â‚±${totalExpected.toFixed(
                2
              )}</div>`;

              const paidCard = document.createElement("div");
              paidCard.className = "summary-card";
              paidCard.innerHTML = `
            <div class="summary-card-title">Total Collected</div>
            <div class="summary-card-value">â‚±${totalPaid.toFixed(2)}</div>
          `;

              const remainingCard = document.createElement("div");
              remainingCard.className = "summary-card";
              remainingCard.innerHTML = `
            <div class="summary-card-title">Total Remaining</div>
            <div class="summary-card-value">â‚±${totalRemaining.toFixed(2)}</div>
          `;

              summaryCards.appendChild(expectedCard);
              summaryCards.appendChild(paidCard);
              summaryCards.appendChild(remainingCard);
              cardBody.appendChild(summaryCards);
            }
          }

          card.appendChild(cardBody);
          sheetContent.innerHTML = "";
          sheetContent.appendChild(card);
        }

        // Distribute excess payment to other sheets
        function distributeExcessPayment(studentId, excess) {
          // Get all sheets except the current one
          const otherSheets = sheets.filter(
            (sheet) => sheet.id !== currentSheetId && sheet.id !== sheets[0].id
          );

          // Sort sheets by date (oldest first)
          otherSheets.sort((a, b) => new Date(a.date) - new Date(b.date));

          let remainingExcess = excess;

          // Distribute excess to unpaid sheets
          for (const sheet of otherSheets) {
            if (remainingExcess <= 0) break;

            const studentInSheet = sheet.students.find(
              (s) => s.id === studentId
            );
            if (studentInSheet && studentInSheet.remainingBalance > 0) {
              const amountToApply = Math.min(
                remainingExcess,
                studentInSheet.remainingBalance
              );
              studentInSheet.amountPaid += amountToApply;
              studentInSheet.remainingBalance = Math.max(
                studentInSheet.expectedPayment - studentInSheet.amountPaid,
                0
              );

              // Update status
              if (studentInSheet.amountPaid === 0) {
                studentInSheet.status = "Unpaid";
              } else if (
                studentInSheet.amountPaid >= studentInSheet.expectedPayment
              ) {
                studentInSheet.status = "Paid";
              } else {
                studentInSheet.status = "Partial";
              }

              remainingExcess -= amountToApply;
            }
          }

          saveData();

          if (remainingExcess > 0) {
            showNotification(
              `â‚±${remainingExcess.toFixed(2)} excess payment for ${
                sheets[0].students.find((s) => s.id === studentId).name
              } will be applied to future sheets`,
              "info"
            );
          }
        }

        // Add sheet modal handlers
        addSheetBtn.addEventListener("click", () => {
          $("#sheet-name").value = "";
          $("#sheet-date").value = todayStr;
          openModal(addSheetModal);
        });
        closeAddSheetModalBtn.addEventListener("click", () =>
          closeModal(addSheetModal)
        );
        cancelAddSheetBtn.addEventListener("click", () =>
          closeModal(addSheetModal)
        );
        addSheetForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const name = $("#sheet-name").value.trim();
          const date = $("#sheet-date").value;
          if (!name || !date)
            return showNotification("Please fill all fields", "error");

          // Check if sheet name already exists
          if (sheets.some((s) => s.name.toLowerCase() === name.toLowerCase())) {
            showNotification("Sheet name already exists", "error");
            return;
          }

          const newSheet = createSheet(name, date);

          // Copy students from default sheet
          const defaultSheet = sheets[0];
          newSheet.students = defaultSheet.students.map((student) => {
            return createStudent(
              student.name,
              0, // Reset payment for new sheet
              student.expectedPayment,
              student.notes,
              student.gender
            );
          });

          sheets.push(newSheet);
          currentSheetId = newSheet.id;
          saveData();
          renderTabs();
          renderSheet();
          // Disable add student for non-default sheets
          addStudentBtn.style.display = "none";
          closeModal(addSheetModal);
          searchInput.value = "";
          showNotification(`Sheet "${name}" created successfully`, "success");
        });

        // Gender selection handlers
        maleBtn.addEventListener("click", () => {
          selectedGender = "male";
          maleBtn.classList.add("selected");
          femaleBtn.classList.remove("selected");
        });

        femaleBtn.addEventListener("click", () => {
          selectedGender = "female";
          femaleBtn.classList.add("selected");
          maleBtn.classList.remove("selected");
        });

        // Add student modal handlers
        addStudentBtn.addEventListener("click", () => {
          $("#student-names").value = "";
          // Reset gender selection to male
          selectedGender = "male";
          maleBtn.classList.add("selected");
          femaleBtn.classList.remove("selected");
          openModal(addStudentModal);
        });
        closeAddStudentModalBtn.addEventListener("click", () =>
          closeModal(addStudentModal)
        );
        cancelAddStudentBtn.addEventListener("click", () =>
          closeModal(addStudentModal)
        );
        addStudentForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const namesText = $("#student-names").value.trim();
          if (!namesText)
            return showNotification("Please enter student names", "error");

          const names = namesText
            .split(",")
            .map((name) => name.trim())
            .filter((name) => name.length > 0);

          if (names.length === 0)
            return showNotification(
              "Please enter valid student names",
              "error"
            );

          const defaultSheet = sheets[0];
          let addedCount = 0;
          let duplicateCount = 0;

          names.forEach((name) => {
            if (
              !defaultSheet.students.some(
                (s) => s.name.toLowerCase() === name.toLowerCase()
              )
            ) {
              defaultSheet.students.push(
                createStudent(
                  name,
                  0,
                  settings.expectedPayment,
                  "",
                  selectedGender
                )
              );
              addedCount++;
            } else {
              duplicateCount++;
            }
          });

          // Auto-sort after adding new students
          defaultSheet.students = sortStudentsByGender(defaultSheet.students);

          // Also sort in all other sheets to keep them consistent
          sheets.slice(1).forEach((sheet) => {
            sheet.students = sortStudentsByGender(sheet.students);
          });

          saveData();
          renderSheet();
          closeModal(addStudentModal);
          searchInput.value = "";

          let message = `Added ${addedCount} student(s) (sorted by gender and name)`;
          if (duplicateCount > 0) {
            message += ` (${duplicateCount} duplicate(s) skipped)`;
          }

          showNotification(message, "success");
        });

        // Settings modal handlers
        openSettingsBtn.addEventListener("click", () => {
          $("#expected-payment").value = settings.expectedPayment.toFixed(2);
          $("#theme-preference").value = settings.theme;
          openModal(settingsModal);
        });
        closeSettingsModalBtn.addEventListener("click", () =>
          closeModal(settingsModal)
        );
        cancelSettingsBtn.addEventListener("click", () =>
          closeModal(settingsModal)
        );
        settingsForm.addEventListener("submit", (e) => {
          e.preventDefault();
          let expectedPayment = parseFloat($("#expected-payment").value);
          if (isNaN(expectedPayment)) expectedPayment = 100;
          const theme = $("#theme-preference").value;

          settings = {
            expectedPayment: Math.max(0, expectedPayment),
            theme: theme,
          };

          applyTheme();
          saveData();
          closeModal(settingsModal);
          renderSheet();
          showNotification("Settings saved successfully", "success");
        });

        // Delete confirmation handlers
        closeDeleteConfirmationModalBtn.addEventListener("click", () =>
          closeModal(deleteConfirmationModal)
        );
        cancelDeleteBtn.addEventListener("click", () =>
          closeModal(deleteConfirmationModal)
        );
        confirmDeleteBtn.addEventListener("click", () => {
          if (!currentDeleteAction) {
            closeModal(deleteConfirmationModal);
            return;
          }

          if (currentDeleteAction.type === "sheet") {
            // Delete sheet
            const sheetIndex = sheets.findIndex(
              (s) => s.id === currentDeleteAction.id
            );
            if (sheetIndex !== -1) {
              // Switch to default sheet if removing current
              if (currentDeleteAction.id === currentSheetId) {
                currentSheetId = sheets[0].id;
              }
              sheets.splice(sheetIndex, 1);
              saveData();
              renderTabs();
              renderSheet();
              // Explicitly show Add Student button when returning to Student List
              addStudentBtn.style.display = "flex";
              showNotification(
                `Sheet "${currentDeleteAction.name}" removed`,
                "success"
              );
            }
          } else if (currentDeleteAction.type === "student") {
            // Delete student
            const sheet = sheets.find(
              (s) => s.id === currentDeleteAction.sheetId
            );
            if (sheet) {
              const studentIndex = sheet.students.findIndex(
                (s) => s.id === currentDeleteAction.studentId
              );
              if (studentIndex !== -1) {
                sheet.students.splice(studentIndex, 1);
                saveData();
                renderSheet();
                showNotification(
                  `Removed ${currentDeleteAction.name} from sheet`,
                  "success"
                );
              }
            }
          }

          closeModal(deleteConfirmationModal);
          currentDeleteAction = null;
        });

        // Theme toggle
        themeToggleBtn.addEventListener("click", () => {
          const newTheme =
            document.body.getAttribute("data-theme") === "dark"
              ? "light"
              : "dark";
          document.body.setAttribute("data-theme", newTheme);
          settings.theme = newTheme;
          saveData();
          updateThemeIcon();
        });

        function updateThemeIcon() {
          const isDark = document.body.getAttribute("data-theme") === "dark";
          themeToggleBtn.innerHTML = isDark
            ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 01.818.162z" clip-rule="evenodd" /></svg>`
            : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z" /></svg>`;
        }

        // Apply theme
        function applyTheme() {
          if (settings.theme === "dark") {
            document.body.setAttribute("data-theme", "dark");
          } else if (settings.theme === "light") {
            document.body.removeAttribute("data-theme");
          } else {
            // System preference
            if (
              window.matchMedia &&
              window.matchMedia("(prefers-color-scheme: dark)").matches
            ) {
              document.body.setAttribute("data-theme", "dark");
            } else {
              document.body.removeAttribute("data-theme");
            }
          }
          updateThemeIcon();
        }

        // Search handler
        searchInput.addEventListener("input", () => {
          renderSheet();
        });

        // Initialize table scrolling indicators
        function initTableScrolling() {
          const tableWrappers = document.querySelectorAll(".table-wrapper");
          tableWrappers.forEach((wrapper) => {
            let isScrolling;

            wrapper.addEventListener("scroll", () => {
              // Add scrolling class when scrolling
              wrapper.classList.add("scrolling");

              // Clear timeout if already set
              clearTimeout(isScrolling);

              // Remove scrolling class after scrolling stops
              isScrolling = setTimeout(() => {
                wrapper.classList.remove("scrolling");
              }, 200);
            });
          });
        }

        // Initialization
        function init() {
          loadData();
          sheets.forEach((sheet) => {
            sheet.students = sortStudentsByGender(sheet.students);
          });
          applyTheme();
          renderTabs();
          renderSheet();
          initTableScrolling();
          // Set initial button state
          addStudentBtn.style.display =
            currentSheetId === sheets[0].id ? "flex" : "none";
          dateDisplay.textContent = "No sheet selected";

          // Set initial gender selection
          maleBtn.classList.add("selected");
        }

        init();
      })();
    </script>
  </body>
</html>
